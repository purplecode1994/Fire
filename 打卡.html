<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>網頁打卡系統</title>
  <style>
    body{
      font-family:sans-serif;
      background:#f6f6f6;
      margin:0;
      padding:16px;
      line-height:1.5;
      word-break:break-word;
    }
    .card{
      background:#fff;
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      max-width:640px;
      margin:0 auto;
      box-shadow:0 4px 16px rgba(0,0,0,.04);
    }
    h1{font-size:20px;margin:0 0 12px;}
    label{display:block;margin:10px 0 4px;font-size:14px;color:#111;}
    input,select,textarea,button{
      width:100%;
      padding:10px;
      border:1px solid #ccc;
      border-radius:10px;
      font-size:16px;
      box-sizing:border-box;
      background:#fff;
    }
    textarea{resize:vertical;}
    .btn{
      margin-top:12px;
      background:#111;
      color:#fff;
      border:none;
      cursor:pointer;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:560px){
      .row{grid-template-columns:1fr;}
    }
    .muted{
      color:#666;
      font-size:12px;
      margin-top:10px;
      white-space:pre-wrap;
    }
    .status{
      white-space:pre-wrap;
      background:#fafafa;
      border:1px dashed #ccc;
      border-radius:10px;
      padding:10px;
      margin-top:12px;
      font-size:13px;
    }
    .toolbar{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .toolbtn{
      flex:1;
      padding:10px;
      border-radius:10px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-size:14px;
    }

    /* Debug UI */
    .debug-wrap{
      margin-top:16px;
      border-radius:12px;
      border:1px solid #ddd;
      overflow:hidden;
    }
    .debug-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      background:#111827;
      color:#e5e7eb;
      font-size:13px;
    }
    .debug-head .left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#0ea5e9;
      color:#001018;
      font-weight:700;
      font-size:12px;
    }
    .switch{
      display:flex;
      align-items:center;
      gap:6px;
      user-select:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .debug-box{
      background:#0f172a;
      color:#e5e7eb;
      padding:12px;
      font-size:12px;
      line-height:1.5;
      white-space:pre-wrap;
      max-height:320px;
      overflow:auto;
    }
    .debug-actions{
      display:flex;
      gap:10px;
      padding:10px 12px;
      background:#0b1220;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .debug-actions button{
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.15);
      background:#111827;
      color:#e5e7eb;
      cursor:pointer;
      font-size:13px;
    }
    .debug-actions button:active{transform:translateY(1px);}
    .warn{
      color:#fbbf24;
      font-weight:700;
    }
    .ok{
      color:#34d399;
      font-weight:700;
    }
    .bad{
      color:#fb7185;
      font-weight:700;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>網頁打卡系統</h1>

    <div class="row">
      <div>
        <label>姓名 / 員編</label>
        <input id="name" placeholder="例如：王小明 / A123" />
      </div>
      <div>
        <label>打卡動作</label>
        <select id="action">
          <option value="IN">上班 IN</option>
          <option value="OUT">下班 OUT</option>
          <option value="BREAK_OUT">外出</option>
          <option value="BREAK_IN">回來</option>
        </select>
      </div>
    </div>

    <div id="desktopWarning" style="
  display:none;
  margin-bottom:12px;
  padding:12px;
  border-radius:10px;
  background:#fff7ed;
  border:1px solid #fed7aa;
  color:#9a3412;
  font-size:14px;
  line-height:1.5;
">
  ⚠️ <b>偵測到你正在使用桌上型電腦</b><br>
  桌機沒有 GPS，定位容易失敗。<br>
  請改用 <b>手機（4G / 5G 或 Wi-Fi）</b> 打卡，成功率最高。
</div>

    <div class="row">
      <div>
        <label>打卡點</label>
        <input id="siteName" placeholder="例如：A棟大廳" />
      </div>
      <div>
        <label>補充</label>
        <input id="note" placeholder="例如：臨時加班 / 設備異常" />
      </div>
    </div>

    <button class="btn" id="btn">打卡（會要求定位權限）</button>

    <div class="toolbar">
      <button class="toolbtn" id="btnQuickRetry" type="button">重新嘗試</button>
      <button class="toolbtn" id="btnShowClient" type="button">顯示設備代號</button>
    </div>

    <div class="muted" id="hint">
需求：
1) 需要允許「位置」權限（建議選精確位置）
2) 定位精度需 ≤100 公尺（室內/地下室常失敗屬正常）
3) 建議用手機打卡，電腦通常不夠準
    </div>

    <div class="status" id="status">尚未打卡。</div>

    <!-- Debug -->
    <div class="debug-wrap" id="debugWrap">
      <div class="debug-head">
        <div class="left">
          <span class="badge">Debug</span>
          <span id="debugSummary">尚未開始</span>
        </div>
        <label class="switch" title="開/關偵錯模式">
          <input id="debugToggle" type="checkbox" />
          <span>偵錯模式</span>
        </label>
      </div>
      <div class="debug-box" id="debugBox">（偵錯模式關閉中）</div>
      <div class="debug-actions">
        <button type="button" id="btnCopyDebug">複製偵錯內容</button>
        <button type="button" id="btnClearDebug">清空偵錯內容</button>
      </div>
    </div>
  </div>

<script>
/* ===========================
   你只要改這裡
   讓它跟 Code.gs 的 SECRET 一樣
=========================== */
const SECRET = "CHANGE_ME_TO_A_LONG_RANDOM_STRING";

/* ===========================
   基本設定
=========================== */
const REQUIRE_ACCURACY_M = 100;    // 需 ≤100m
const GEO_TIMEOUT_MS     = 20000;  // 定位等待
const GEO_MAX_AGE_MS     = 0;      // 不用快取
const GEO_HIGH_ACCURACY  = true;   // 高精度

const statusEl = document.getElementById('status');
const btn = document.getElementById('btn');
const btnQuickRetry = document.getElementById('btnQuickRetry');
const btnShowClient = document.getElementById('btnShowClient');

const debugWrap = document.getElementById('debugWrap');
const debugBox = document.getElementById('debugBox');
const debugToggle = document.getElementById('debugToggle');
const debugSummary = document.getElementById('debugSummary');
const btnCopyDebug = document.getElementById('btnCopyDebug');
const btnClearDebug = document.getElementById('btnClearDebug');

let DEBUG = false;
let debugLogText = "";

/* ===========================
   UI Helper
=========================== */
function logStatus(msg){
  statusEl.textContent = msg;
}

function setDebugSummary(msg){
  debugSummary.textContent = msg;
}

function nowTime(){
  return new Date().toLocaleTimeString();
}

function debug(msg, obj){
  if(!DEBUG) return;
  let text = `[${nowTime()}] ${msg}`;
  if(obj !== undefined){
    try{ text += "\n" + JSON.stringify(obj, null, 2); }
    catch(e){ text += "\n" + String(obj); }
  }
  debugLogText += (debugLogText ? "\n\n" : "") + text;
  debugBox.textContent = debugLogText;
  debugBox.scrollTop = debugBox.scrollHeight;
}

function debugReset(initialText){
  debugLogText = initialText || "";
  debugBox.textContent = debugLogText || (DEBUG ? "（開始偵錯）" : "（偵錯模式關閉中）");
}

function safeRound(n){
  if(typeof n !== "number") return n;
  return Math.round(n * 1000000) / 1000000;
}

/* ===========================
   Device / Network Info
=========================== */
function getOrCreateClientId(){
  const key = "clock_client_id";
  let v = localStorage.getItem(key);
  if(!v){
    v = (crypto.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2)));
    localStorage.setItem(key, v);
  }
  return v;
}

function getDeviceType(){
  return (Math.min(screen.width, screen.height) <= 768) ? "mobile" : "desktop";
}

function parseOS(ua){
  ua = ua || "";
  if(/Android/i.test(ua)) return "Android";
  if(/iPhone|iPad|iPod/i.test(ua)) return "iOS";
  if(/Windows/i.test(ua)) return "Windows";
  if(/Mac OS X/i.test(ua)) return "macOS";
  if(/Linux/i.test(ua)) return "Linux";
  return "Unknown";
}

function parseBrowser(ua){
  ua = ua || "";
  if(/Edg/i.test(ua)) return "Edge";
  if(/Chrome/i.test(ua) && !/Edg/i.test(ua)) return "Chrome";
  if(/Safari/i.test(ua) && !/Chrome/i.test(ua)) return "Safari";
  if(/Firefox/i.test(ua)) return "Firefox";
  return "Unknown";
}

function getNetworkInfo(){
  const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  if(!c) return { networkType: "unknown", effectiveType: "unknown", rtt: "unknown", downlink: "unknown" };

  return {
    networkType: c.type || "unknown",
    effectiveType: c.effectiveType || "unknown",
    rtt: (typeof c.rtt === "number" ? c.rtt : "unknown"),
    downlink: (typeof c.downlink === "number" ? c.downlink : "unknown")
  };
}

/* ===========================
   Geolocation
=========================== */
function getPreciseLocation(){
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation){
      reject(new Error("此瀏覽器不支援定位"));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        resolve({
          lat: latitude,
          lng: longitude,
          accuracyM: accuracy
        });
      },
      err => {
        // err.code: 1 PERMISSION_DENIED, 2 POSITION_UNAVAILABLE, 3 TIMEOUT
        reject(err);
      },
      {
        enableHighAccuracy: GEO_HIGH_ACCURACY,
        timeout: GEO_TIMEOUT_MS,
        maximumAge: GEO_MAX_AGE_MS
      }
    );
  });
}

function friendlyGeoError(err){
  if(!err) return "未知錯誤";
  if(typeof err === "string") return err;

  // GeolocationPositionError
  const code = err.code;
  const msg = err.message || String(err);

  if(code === 1) return "你拒絕了定位權限（請到瀏覽器/系統把位置權限改成允許，並開啟精確位置）";
  if(code === 2) return "目前無法取得位置（可能在室內/地下室或定位服務關閉）";
  if(code === 3) return "定位逾時（請到室外或等待 GPS 收訊再試）";
  return msg;
}

/* ===========================
   Main Punch Flow
=========================== */
async function punch(){
  btn.disabled = true;

  // 每次打卡先把 debug 準備好
  if(DEBUG) debugReset("");

  try{
    const ua = navigator.userAgent || "";
    const clientId = getOrCreateClientId();
    const net = getNetworkInfo();

    setDebugSummary("流程開始");
    debug("開始打卡流程");
    debug("基本環境", {
      href: location.href,
      geolocationSupported: !!navigator.geolocation,
      userAgent: ua
    });
    debug("裝置/瀏覽器", {
      clientId,
      deviceType: getDeviceType(),
      os: parseOS(ua),
      browser: parseBrowser(ua)
    });
    debug("網路資訊（可能因瀏覽器而缺少）", net);

    logStatus("請稍等：正在取得高精度定位…");
    setDebugSummary("取得定位中");
    debug("嘗試取得高精度定位", {
      enableHighAccuracy: GEO_HIGH_ACCURACY,
      timeoutMs: GEO_TIMEOUT_MS,
      maximumAgeMs: GEO_MAX_AGE_MS
    });

    const loc = await getPreciseLocation();
    debug("定位成功", {
      lat: safeRound(loc.lat),
      lng: safeRound(loc.lng),
      accuracyM: loc.accuracyM
    });

    const within100m = (typeof loc.accuracyM === "number") ? (loc.accuracyM <= REQUIRE_ACCURACY_M) : false;

    debug("定位精度檢查", {
      requireAccuracyM: REQUIRE_ACCURACY_M,
      accuracyM: loc.accuracyM,
      pass: within100m
    });

    if(!within100m){
      setDebugSummary("定位精度不足");
      logStatus(
        "定位成功，但精度不足。\n" +
        `目前誤差：約 ${Math.round(loc.accuracyM)} 公尺（需 ≤ ${REQUIRE_ACCURACY_M} 公尺）\n` +
        "建議：到室外 / 開啟手機 GPS / iPhone 開啟精確位置 / 等 10～20 秒再試。"
      );
      return;
    }

    const payload = {
      secret: SECRET,
      action: document.getElementById('action').value,
      name: document.getElementById('name').value.trim(),
      siteName: document.getElementById('siteName').value.trim(),
      note: document.getElementById('note').value.trim(),

      clientId,
      deviceType: getDeviceType(),
      os: parseOS(ua),
      browser: parseBrowser(ua),

      networkType: net.networkType,
      effectiveType: net.effectiveType,

      lat: loc.lat,
      lng: loc.lng,
      accuracyM: loc.accuracyM,
      within100m: within100m,

      userAgent: ua
    };

    debug("準備送出 payload", payload);

    logStatus("定位 OK（≤100m）。\n正在寫入打卡紀錄…");
    setDebugSummary("寫入中");

    const res = await fetch(location.href, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    debug("HTTP 回應狀態", {
      status: res.status,
      statusText: res.statusText
    });

    const rawText = await res.text();
    debug("HTTP 原始回應（raw）", rawText);

    let data = {};
    try{ data = JSON.parse(rawText); }
    catch(e){ data = { ok:false, error:"回應不是 JSON（可能是部署/權限/錯誤頁）" }; }

    debug("Apps Script 回傳 JSON", data);

    if(!res.ok || !data.ok){
      setDebugSummary("寫入失敗");
      const errMsg = data.error || ("HTTP " + res.status);
      throw new Error(errMsg);
    }

    setDebugSummary("完成");
    logStatus(
      "打卡完成 ✅\n" +
      `伺服器紀錄時間：${data.savedAt}\n` +
      `定位誤差：約 ${Math.round(loc.accuracyM)} 公尺\n` +
      `網路：${net.networkType} / ${net.effectiveType}\n` +
      `設備代號：${clientId}`
    );

  }catch(err){
    const msg = (err && err.message) ? err.message : String(err);

    // 如果是定位錯誤物件，轉成友善訊息
    const friendly = (err && typeof err.code === "number") ? friendlyGeoError(err) : msg;

    setDebugSummary("錯誤");
    debug("❌ 發生錯誤", {
      message: msg,
      friendly,
      code: err && err.code ? err.code : null,
      stack: err && err.stack ? err.stack : null
    });

    logStatus("打卡失敗 ❌\n" + friendly);
  }finally{
    btn.disabled = false;
  }
}

/* ===========================
   Debug Toggle & Buttons
=========================== */
debugToggle.addEventListener('change', () => {
  DEBUG = !!debugToggle.checked;
  if(DEBUG){
    debugReset("");
    setDebugSummary("偵錯模式已開啟");
    debug("偵錯模式已開啟");
  }else{
    debugReset("");
    setDebugSummary("偵錯模式已關閉");
  }
});

btnCopyDebug.addEventListener('click', async () => {
  const text = debugLogText || "（目前沒有偵錯內容）";
  try{
    await navigator.clipboard.writeText(text);
    alert("已複製偵錯內容。\n你可以直接貼回來給我。");
  }catch(e){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert("已複製偵錯內容（fallback）。\n你可以直接貼回來給我。");
  }
});

btnClearDebug.addEventListener('click', () => {
  debugReset("");
  setDebugSummary(DEBUG ? "已清空" : "偵錯模式關閉中");
});

btn.addEventListener('click', punch);

btnQuickRetry.addEventListener('click', () => {
  logStatus("準備重新嘗試…");
  if(DEBUG){
    debug("使用者點了重新嘗試");
  }
  punch();
});

btnShowClient.addEventListener('click', () => {
  const id = getOrCreateClientId();
  const msg = "設備代號（clientId）：\n" + id;
  logStatus(msg);
  if(DEBUG){
    debug("顯示設備代號", id);
  }
});

/* ===========================
   Page Init
=========================== */
(function init(){
  // 預設：偵錯關閉（你要一開始就開可改成 true）
  DEBUG = false;
  debugToggle.checked = false;
  debugReset("");
  setDebugSummary("尚未開始");

  // 顯示基本提示到 debug（如果使用者開啟偵錯就會看得到）
})();

(function checkDeviceAndWarn(){
  const isDesktop =
    !/Android|iPhone|iPad|iPod/i.test(navigator.userAgent) &&
    Math.min(screen.width, screen.height) > 768;

  const warning = document.getElementById('desktopWarning');
  const punchBtn = document.getElementById('btn');

  if(isDesktop){
    // 顯示提示
    warning.style.display = "block";

    // 停用打卡按鈕
    punchBtn.disabled = true;

    // 同時在狀態列顯示原因
    const status = document.getElementById('status');
    if(status){
      status.textContent =
        "⚠️ 目前為桌上型電腦環境。\n" +
        "桌機沒有 GPS，定位成功率低。\n" +
        "請改用手機打卡。";
    }
  }
})();
</script>
</body>
</html>