<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€²åº¦æŸ¥è©¢</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* é¡å¤–å¡ç‰‡æ¨£å¼ */
    .detail-card {
      background: #fdfdfd;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      font-size: 15px;
      line-height: 1.6;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .detail-card p { margin: 8px 0; }
    .detail-card b { color: #333; }

    /* JSON å€å¡Šï¼ˆDebugï¼‰ */
    #debugJson {
      background:#1e1e1e;
      color:#d4d4d4;
      padding:15px;
      margin-top:15px;
      border-radius:6px;
      font-family: "Courier New", monospace;
      font-size:14px;
      line-height:1.5;
      overflow-x:auto;
      white-space:pre-wrap;
      box-shadow:inset 0 0 5px rgba(0,0,0,0.3);
      text-align:left;
    }

    /* === å±•é–‹ç´°é …å‹•ç•« === */
    .detail-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      margin-top: 0;
      transition: max-height .5s ease, opacity .4s ease, margin-top .4s ease;
    }
    .detail-content.show {
      max-height: 500px; /* è¶³å¤ å¤§çš„å€¼ä»¥å®¹ç´å…§å®¹ */
      opacity: 1;
      margin-top: 12px;  /* ç•™ç™½ï¼Œé¿å…å¤ªçªå…€ */
    }
  </style>
</head>
<body>
  <div class="box">
    <h2>åºåˆ—è™Ÿé€²åº¦æŸ¥è©¢</h2>
    <label>è¼¸å…¥åºåˆ—è™Ÿ
      <input type="text" id="serialInput" placeholder="ä¾‹å¦‚ï¼šA250828145933123">
    </label>
    <button class="btn-query" onclick="checkSerial()">æŸ¥è©¢é€²åº¦</button>

    <!-- ç‹€æ…‹æç¤º -->
    <div id="queryResult"></div>

    <!-- å¯è®€è³‡è¨Šï¼ˆçµ¦ä½¿ç”¨è€…çœ‹ï¼‰ -->
    <div id="detailBox" class="detail-card hidden"></div>

    <!-- JSON åŸå§‹å…§å®¹ï¼ˆçµ¦ Debugï¼‰ -->
    <pre id="debugJson" class="hidden">{}</pre>

    <div class="back"><a href="index.html">â† è¿”å›å…¥å£</a></div>
  </div>
<script>
function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return d.getFullYear() + "-" +
         String(d.getMonth() + 1).padStart(2, "0") + "-" +
         String(d.getDate()).padStart(2, "0");
}

const GAS_URL = "https://script.google.com/macros/s/AKfycbxK_4aX7MS9m6vJKiX8xLvJFGf5DMMG6oVydnbaM-HZBD2DzwAa3ULd-JlSgrabWzY2LA/exec";

function checkSerial(){
  const serial = document.getElementById("serialInput").value.trim();
  const box = document.getElementById("queryResult");
  const detailBox = document.getElementById("detailBox");
  const debugBox = document.getElementById("debugJson");

  if(!serial){
    box.textContent = "è«‹è¼¸å…¥åºåˆ—è™Ÿ";
    box.className = "status-error show";
    detailBox.classList.add("hidden");
    debugBox.textContent = "{}";
    return;
  }

  fetch(GAS_URL + "?serial=" + encodeURIComponent(serial))
    .then(res => res.json())
    .then(data => {
      debugBox.textContent = JSON.stringify(data, null, 2);
      detailBox.classList.add("hidden");
      detailBox.innerHTML = "";

      if(data.success){
        if(data.status === "ç”³è«‹ä¸­"){
          box.textContent = "â³ ç”³è«‹ä¸­";
          box.className = "status-pending show";
        } else if(data.status === "å·²æ ¸å‡†"){
          box.textContent = "âœ… å·²æ ¸å‡†";
          box.className = "status-approved show";
        }

        let shortItem = data.item.length > 8 ? data.item.slice(0,8) + "â€¦" : data.item;
        let displayItem = data.brand ? `${data.brand} ${shortItem}` : shortItem;

        let html = `
          <p>ğŸ“Œ <b>åºåˆ—è™Ÿï¼š</b>${data.serial}</p>
          <p>ğŸ¢ <b>ç”³è«‹å–®ä½ï¼š</b>${data.unit}</p>
          <p>ğŸ“… <b>ç”³è«‹æ—¥æœŸï¼š</b>${formatDate(data.date)}</p>
          <p>ğŸ›’ <b>å“é …å…§å®¹ï¼š</b>${displayItem}</p>
          <button class="btn-query" onclick="toggleDetail(this)">ğŸ”½ å±•é–‹ç´°é …</button>
          <div class="detail-content">
            <p>â€¢ å“é …å…§å®¹ï¼š${data.item}</p>
            <p>â€¢ è¦æ ¼ï¼š${data.spec}</p>
            <p>â€¢ å–®ä½ï¼š${data.unitType}</p>
          </div>
        `;

        // ğŸ”½ å¦‚æœæ˜¯å·²æ ¸å‡†ï¼ŒåŠ ä¸Šå‰å¾€è«‹è³¼æŒ‰éˆ•
if(data.status === "å·²æ ¸å‡†"){
  html += `
    <button id="btnPurchase" class="btn-apply">
      â¡ å‰å¾€è«‹è³¼ç”³è«‹
    </button>
  `;
}

detailBox.innerHTML = html;
detailBox.classList.remove("hidden");

// === åœ¨é€™è£¡æ›äº‹ä»¶ ===
if(data.status === "å·²æ ¸å‡†"){
  const btn = document.getElementById("btnPurchase");
  btn.addEventListener("click", () => {
    goToPurchase(data);
  });
}
      } else {
        box.textContent = data.display || "âŒ æŸ¥ç„¡æ­¤åºåˆ—è™Ÿ";
        box.className = "status-error show";
      }
    })
    .catch(err => {
      box.textContent = "âš ï¸ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤";
      box.className = "status-error show";
      detailBox.classList.add("hidden");
      debugBox.textContent = "{}";
    });
}

function toggleDetail(btn){
  const detail = btn.nextElementSibling;
  detail.classList.toggle("show");
  btn.textContent = detail.classList.contains("show") ? "â–² æ”¶èµ·ç´°é …" : "ğŸ”½ å±•é–‹ç´°é …";
}

// æŠŠè³‡æ–™å­˜åˆ° localStorageï¼Œç„¶å¾Œè·³è½‰
function goToPurchase(data){
  // åªå­˜éœ€è¦çš„æ¬„ä½ï¼Œé¿å…è¶…é localStorage é™åˆ¶
  const payload = {
    productName: (data.brand ? data.brand + " " : "") + data.item,
    specification: data.spec + " / " + data.unitType,
    unit: data.unit
  };
  
  try {
    localStorage.setItem("purchaseData", JSON.stringify(payload));
    window.location.href = "simplified-purchase-form.html";
  } catch (e) {
    console.error("å­˜å…¥ localStorage å¤±æ•—", e);
    alert("âš ï¸ è³‡æ–™éå¤§ç„¡æ³•å‚³éï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚");
  }
}

document.addEventListener("DOMContentLoaded", function(){
  const saved = localStorage.getItem("purchaseData");
  if(saved){
    try {
      const data = JSON.parse(saved);
      if(data.productName){
        document.getElementById("productName").value = data.productName;
      }
      if(data.specification){
        document.getElementById("specification").value = data.specification;
      }
      if(data.unit){
        document.getElementById("department").value = data.unit;
      }
    } catch(e){
      console.error("è§£æ purchaseData å¤±æ•—", e);
    }
  }
});

</script>
</body>
</html>
